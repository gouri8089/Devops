<!DOCTYPE html>
<html lang="en">
  <script>
    const token1 = localStorage.getItem("token");
    if (!token1) {
      alert("You are not logged in. Redirecting to login page.");
      window.location.href = "./login.html";
    }
  </script>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Alerts</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg p-6 hidden md:block">
      <h1 class="text-2xl font-bold text-blue-600 mb-8">Alert System</h1>
      <nav class="space-y-4">
        <a href="./dashboard.html" class="block text-gray-700 hover:text-blue-600 font-medium">Dashboard</a>
        <a href="./add-alert.html" class="block text-gray-700 hover:text-blue-600 font-medium">Add Alert</a>
        <a href="#" class="block text-blue-600 font-bold">My Alerts</a>
        <a href="./preferences.html" class="block text-gray-700 hover:text-blue-600 font-medium">Preferences</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
      <!-- Navbar -->
      <header class="bg-white shadow-md flex items-center justify-between px-6 py-4">
        <div class="flex items-center space-x-4">
          <img src="./images/logo.avif" class="h-10 w-10 rounded-full" alt="Logo" />
          <span class="text-xl font-semibold text-gray-800">My Alerts</span>
        </div>
        <div class="flex items-center space-x-4">
          <img src="./images/user.png" class="h-10 w-10 rounded-full" alt="Profile" />
          <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
          <script src="./js/logout.js"></script>
        </div>
      </header>

      <!-- Page Content -->
      <main class="p-6 flex-1">
        <h2 class="text-2xl font-semibold mb-6">Your Alerts</h2>

        <!-- Filters -->
        <div class="bg-white p-4 rounded-lg shadow mb-6 flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
          <div class="flex items-center space-x-2">
            <label for="timeFilter" class="text-gray-700 font-medium">Filter by Time:</label>
            <select id="timeFilter" class="border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
              <option value="all">All</option>
              <!-- <option value="week">This Week</option> -->
              <option value="month">This Month</option>
              <option value="year">This Year</option>
            </select>
          </div>
          <div class="flex items-center space-x-2">
            <label for="itemFilter" class="text-gray-700 font-medium">Filter by Item:</label>
            <input type="text" id="itemFilter" placeholder="Search document name"
              class="border rounded p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
          </div>
        </div>

        <!-- Alerts Table -->
        <div class="bg-white rounded-xl shadow overflow-auto">
          <table class="min-w-full text-left text-sm">
            <thead class="bg-gray-100 text-gray-700 font-semibold">
              <tr>
                <th class="p-4">Alert ID</th>
                <th class="p-4">Document Name</th>
                <th class="p-4">Expiry Date</th>
                <th class="p-4">Method</th>
                <th class="p-4">Status</th>
                <th class="p-4">Action</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200" id="alertsTableBody">
              <!-- Dynamic rows injected here -->
            </tbody>
          </table>
        </div>
      </main>
    </div>

    <script>
      const token = localStorage.getItem("token");
      const tableBody = document.getElementById("alertsTableBody");
      const timeFilter = document.getElementById("timeFilter");
      const itemFilter = document.getElementById("itemFilter");

      let alerts = [];

      // Fetch Alerts
      async function fetchAlerts() {
        try {
          const res = await fetch("/api/alerts/my-alerts", {
            headers: { Authorization: `Bearer ${token}` },
          });
          const data = await res.json();
          console.log(token)
          alerts = data.alerts || [];
          console.log("Fetched alerts:", alerts);
          renderAlerts();
        } catch (err) {
          console.error("Failed to fetch alerts:", err);
        }
      }

      // Render Alerts in Table
      function renderAlerts() {
  const timeVal = timeFilter.value;
  const itemVal = itemFilter.value.toLowerCase();
  const now = new Date();

  const filtered = alerts.filter(alert => {
    const alertDate = new Date(alert.alert_date);

    const matchTime =
      timeVal === "all" ||
      //(timeVal === "week" && (now - alertDate) / (1000 * 60 * 60 * 24) <= 7) ||
      (timeVal === "month" && now.getMonth() === alertDate.getMonth()) ||
      (timeVal === "year" && now.getFullYear() === alertDate.getFullYear());

    const matchItem = (alert.item_name || '').toLowerCase().includes(itemVal);
    return matchTime && matchItem;
  });

  tableBody.innerHTML = filtered
    .map(
      (a) => `
    <tr>
      <td class="p-4 text-gray-600">${a.alert_id ? a.alert_id.slice(-5).toUpperCase() : "N/A"}</td>
      <td class="p-4">${a.item_name || "N/A"}</td>
      <td class="p-4">${
        a.alert_date
          ? new Date(a.alert_date).toISOString().split("T")[0]
          : "N/A"
      }</td>
      <td class="p-4">${(a.alert_method || "N/A").toUpperCase()}</td>
      <td class="p-4 text-yellow-600 font-medium">${a.is_sent ? "Sent" : "Pending"}</td>
      <td class="p-4">
        <button class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm"
          onclick="deleteAlert('${a._id}')">Delete</button>
      </td>
    </tr>`
    )
    .join("");
}

      // Delete Alert
      async function deleteAlert(alertId) {
        if (!confirm("Are you sure you want to delete this alert?")) return;

        try {
          const res = await fetch(`/api/alerts/${alertId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          const result = await res.json();

          if (res.ok) {
            alerts = alerts.filter((a) => a._id !== alertId);
            renderAlerts();
            alert("Alert deleted successfully!");
          } else {
            alert(result.error || "Error deleting alert.");
          }
        } catch (err) {
          console.error("Delete failed:", err);
          alert("Failed to delete alert.");
        }
      }

      // Filters
      timeFilter.addEventListener("change", renderAlerts);
      itemFilter.addEventListener("input", renderAlerts);

      // Initial fetch
      fetchAlerts();
    </script>
  </body>
</html>
